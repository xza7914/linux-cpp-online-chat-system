# 用c++实现的实时聊天系统
# 功能
---
- 注册、登录、登出、设置和修改密码。
- 设置自身昵称、性别、学校、出生日期和个性签名等信息。
- 通过账号获取他人的部分信息，例如昵称和在线状态。
- 添加或者删除好友，添加请求可以被拒绝。
- 向好友发送消息，若好友在线则会立即收到，若不在线则等其上线时收到。
- 由于没有界面，只能采用命令行操作，文件ORDER.md说明了操作方法。

# 实现
---
- 主线程负责监听新的连接、管理epoll上事件的注册与删除以及在收到客户请求时告知线程池中的线程来处理请求。
- 主线程和线程池的通信主要依靠信号量，池中的线程总是对信号量执行P操作，而主线程收到新的请求后将请求类放入池的工作队列中并对信号量执行V操作。所有的线程在访问工作队列前都要先获取工作队列的互斥锁。此外，还提供了一个管道以便池中的线程向主线程发送消息。
- User_manage类用来实现对用户数据的管理，包括将用户信息存入数据库和从数据库中查询用户的信息。
- 服务器与客户端的交流只有一个端口，采用一问一答的方式。客户端向服务器发送请求后，必须收到服务器的回应后才能继续工作。这种模式使得服务器只有在socket上有数据可读的时才会调用recv函数，从而不会陷入阻塞中。
- 对于客户端属于被动的场景，例如来自好友的消息。采用计时查询的方式，当好友通过服务器向用户发消息时，服务器会将消息存在用户的User对象的消息队列中，而用户每隔一段时间就会向服务器发送查询请求，此时服务器会检查用户的消息队列，并在队列不为空是将消息发送非用户。
- 客户端使用线程来计时，工作时计时线程一直获取当前的时间，脉冲间隔为500ms。当与上一次记录的时间差大于等于500ms时，计时线程会通过事先准备好的管道的写端向客户端主线程发送消息，并更新时间记录。
- 客户端在epoll上注册标准输入流和管道的读端。
- 对于离线的用户，其收到的消息会暂时存储在文件中。每个用户都有自己的消息文件，但服务器不会全部创建，只会在必要时为用户创建相应的文件，由于消息都是字符串形式所以用txt存储。
- 用户登录时，服务器将该用户消息文件中的内容读出并添加到消息队列中，用户下线时，服务器将消息队列中剩余的消息存入文件中。收到消息时，服务器根据用户是否在线来决定将消息加入消息队列还是写入消息文件。
